name: Docker CI/CD Multi-Branch Pipeline

permissions:
  contents: write
  pull-requests: read
  security-events: write

on:
  pull_request:
    branches: [main, release]
    types: [opened, synchronize, reopened]

  # push:
  #   branches: [release, main]

jobs:
  call-unit-tests:
    name: Unit Tests
    uses: riti-bhandari/CICD_demoapp/.github/workflows/unit-test.yml@main
    with:
      working-directory: .

  call-security-checks:
    name: Security code checks
    uses: riti-bhandari/CICD_demoapp/.github/workflows/Security-checks.yml@main
    with:
      working-directory: .

  docker-build-scan:
    name: Docker Build & Trivy Scan
    needs: [call-unit-tests, call-security-checks]
    uses: riti-bhandari/CICD_demoapp/.github/workflows/docker-build.yml@main
    with:
      image-name: my-app
      image-tag: ci
      dockerfile-path: Dockerfile
      build-context: .

  release:
    name: Tag and Push Docker Image
    # if: >
    #   github.event_name == 'push' &&
    #   (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/main')

    uses: riti-bhandari/CICD_demoapp/.github/workflows/tag-push.yml@main
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
    with:
      debug: true
      image-name: my-app
      build-context: .
      dockerfile-path: Dockerfile

  update-deployment:
    name: Update Deployment Repo
    needs: [release]
    uses: riti-bhandari/CICD_demoapp/.github/workflows/update-tag-chart.yml@main
    secrets:
      GH_PAT: ${{ secrets.GH_PAT }}
    with:
      debug: true
      image-tag: ${{ needs.release.outputs.latest-tag }}
      deployment-repo: riti-bhandari/deployment-repo
      env: ${{ github.base_ref == 'release' && 'prod' || 'dev' }} #github.base_ref gives target branch of a PR
      app: app1

  deploy:
    name: deploy
    needs: [update-deployment]
    uses: riti-bhandari/deployment-repo/.github/workflows/cd-prod.yml@main
    with:
      env: prod
      # ${{ github.base_ref == 'release' && 'prod' || 'dev' }} #github.base_ref gives target branch of a PR
      app: app1
      region: eu
      latest-chart: ${{ needs.update-deployment.outputs.chart-version }}
    secrets: 
      AZURE_VM_IP: ${{ secrets.AZURE_VM_IP }}
      AZURE_VM_USER: ${{ secrets.AZURE_VM_USER }}
      AZURE_VM_SSH_KEY: ${{ secrets.AZURE_VM_SSH_KEY }}
      





  # deploy:
  #   name: Deploy to AKS with Helm
  #   needs: [release]
  #   uses: riti-bhandari/CICD_demoapp/.github/workflows/deploy-helm.yml@main
  #   with:
  #     debug: true
  #     image-name: my-app
  #     image-tag: ${{ needs.release.outputs.latest-tag }}

  #     # ðŸ”‘ Dynamic env resolution (NO env: block)
  #     environment: ${{ github.ref == 'refs/heads/release' && 'prod' || 'dev' }}
  #     release_name: my-app-${{ github.ref == 'refs/heads/release' && 'prod' || 'dev' }}
  #     namespace: ${{ github.ref == 'refs/heads/release' && 'prod' || 'dev' }}
  #     helm-values-file: ${{ github.ref == 'refs/heads/release' && 'values-prod.yaml' || 'values-dev.yaml' }}

  #   secrets:
  #     AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  #     AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  #     AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  #     AKS_RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP }}
  #     AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}
  #     DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
