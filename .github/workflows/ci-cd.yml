name: Docker CI Multi-Branch Pipeline

permissions:
  contents: write
  pull-requests: read

on:
  pull_request:
    branches: [main, release]
    types: [closed]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Run unit tests
      run: |
        chmod +x test-scripts/unit-test.sh
        ./test-scripts/unit-test.sh

    - name: Run code linting
      run: mvn checkstyle:check
      continue-on-error: true

    - name: Run static code analysis
      run: mvn spotbugs:check

    - name: Run Gitleaks secret scan
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Fetch git tags
      run: git fetch --tags

    - name: Get latest tag
      run: |
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        echo "LAST_TAG=$LAST_TAG" >> $GITHUB_ENV

    - name: Decide version bump
      if: github.event.pull_request.merged == true
      run: |
        VERSION=${LAST_TAG#v}
        IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
    
        SOURCE_BRANCH="${{ github.event.pull_request.head.ref }}"
        TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"
    
        echo "Source: $SOURCE_BRANCH"
        echo "Target: $TARGET_BRANCH"
    
        # DEFAULT: no tagging
        SHOULD_TAG=false
    
        if [[ "$SOURCE_BRANCH" == hotfix/* && "$TARGET_BRANCH" == "release" ]]; then
          PATCH=$((PATCH + 1))
          SHOULD_TAG=true
    
        elif [[ "$SOURCE_BRANCH" == main && "$TARGET_BRANCH" == "release" ]]; then
          MINOR=$((MINOR + 1))
          PATCH=0
          SHOULD_TAG=true
        fi
    
        if [[ "$SHOULD_TAG" == "true" ]]; then
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          NEW_TAG="v$NEW_VERSION"
    
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV
        else
          echo "No tagging for this merge"
        fi

    - name: Configure git user
      if: env.NEW_TAG != ''
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"

    - name: Create & push git tag
      if: env.NEW_TAG != ''
      run: |
        git tag -a "$NEW_TAG" -m "Release $NEW_TAG"
        git push origin "$NEW_TAG"

    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Set image tag
      run: |
        if [ -n "${NEW_VERSION}" ]; then
          echo "IMAGE_TAG=${NEW_VERSION}" >> $GITHUB_ENV
        else
          echo "IMAGE_TAG=pr-${{ github.event.pull_request.number }}" >> $GITHUB_ENV
        fi

    - name: Build Docker image
      run: |
            docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/my-app:${IMAGE_TAG} .

    - name: Scan Docker image with Trivy
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/my-app:${{ env.IMAGE_TAG }}
        format: table
        exit-code: 1
        severity: HIGH,CRITICAL

    - name: Push Docker image
      if: env.NEW_VERSION != ''
      run: |
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/my-app:${NEW_VERSION}

        
